name: Android Emulator with Mitmproxy

on:
  workflow_dispatch:

jobs:
  run_emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        lfs: true   # download APK via LFS

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip wget unzip libvirt-clients libvirt-daemon-system qemu-kvm
        pip install mitmproxy

    - name: Download & set up Android SDK
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: x86_64
        script: |
          echo "Emulator started"

          # Install your APK
          adb install -r base-patched.apk

          # Install mitmproxy certificate into Android
          mitmproxy --quit
          mkdir -p ~/.mitmproxy
          mitmproxy --quiet --save-stream-file capture.mitm &
          sleep 5

          # Fetch mitmproxy certificate
          cp ~/.mitmproxy/mitmproxy-ca-cert.pem mitm.pem

          # Push certificate to /sdcard and into system cert store
          adb push mitm.pem /sdcard/
          adb shell su -c 'mount -o remount,rw /system'
          adb shell su -c 'cp /sdcard/mitm.pem /system/etc/security/cacerts/'
          adb shell su -c 'chmod 644 /system/etc/security/cacerts/mitm.pem'
          adb shell su -c 'mount -o remount,ro /system'
          adb reboot
          sleep 30

          # Enable proxy inside Android
          adb shell settings put global http_proxy 127.0.0.1:8080

          echo "Proxy enabled"

          # Loop: clear data → start app → wait → repeat
          for i in {1..10}
          do
            echo "Iteration $i"
            adb shell pm clear newway.open.chatgpt.ai.chat.bot.free
            adb shell monkey -p newway.open.chatgpt.ai.chat.bot.free -c android.intent.category.LAUNCHER 1
            sleep 20
          done

    - name: Upload mitmproxy capture
      uses: actions/upload-artifact@v4
      with:
        name: traffic-log
        path: capture.mitm
