name: Run APK in Emulator

on:
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Create AVD
      run: |
        yes "no" | avdmanager create avd \
          --name test \
          --package "system-images;android-30;google_apis;x86_64" \
          --device "Nexus 6"

    - name: Start emulator
      run: |
        nohup emulator -avd test \
          -no-window \
          -gpu swiftshader_indirect \
          -no-snapshot \
          -noaudio \
          -no-boot-anim \
          > /dev/null 2>&1 &
        sleep 8

    - name: Wait for boot
      run: |
        adb wait-for-device
        for i in {1..45}; do
          booted=$(adb shell getprop sys.boot_completed 2>/dev/null)
          if [[ "$booted" == "1" ]]; then
            echo "Emulator ready."
            exit 0
          fi
          echo "Booting emulator ($i)..."
          sleep 4
        done
        echo "Emulator failed to boot."
        exit 1

    - name: Install APK
      run: adb install base-patched.apk

    - name: Launch App
      run: |
        # Replace with your actual package name
        adb shell monkey -p newway.open.chatgpt.ai.chat.bot.free -c android.intent.category.LAUNCHER 1

    - name: Print logcat
      run: adb logcat -d
