name: Run APK in Emulator

on:
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest

    steps:
      # ... (Steps Checkout, Setup SDK, Install System Image remain the same) ...

      - name: Find Launch Activity Name from APK
        id: find_activity
        # ... (This step remains the same) ...
        run: |
          BUILD_TOOLS_DIR=$(find $ANDROID_SDK_ROOT/build-tools/ -maxdepth 1 -type d | sort -r | head -n 1)
          AAPT_PATH="$BUILD_TOOLS_DIR/aapt"
          
          echo "Using AAPT path: $AAPT_PATH"
          
          ACTIVITY_INFO=$("$AAPT_PATH" dump badging base-patched.apk | grep "launchable-activity: name")
          ACTIVITY_NAME=$(echo "$ACTIVITY_INFO" | sed -n "s/.*name='\\([^']\\+\\).*/\\1/p")

          if [ -z "$ACTIVITY_NAME" ]; then
            echo "Error: Could not find launchable-activity in APK manifest."
            exit 1
          fi
          
          echo "activity_name=$ACTIVITY_NAME" >> "$GITHUB_OUTPUT"
          echo "Found Activity: $ACTIVITY_NAME"
          
      - name: Create Emulator Control Script
        env:
          ACTIVITY_NAME: ${{ steps.find_activity.outputs.activity_name }}
          PACKAGE_NAME: newway.open.chatgpt.ai.chat.bot.free
        run: |
          APP_ACTIVITY="${{ steps.find_activity.outputs.activity_name }}"
          APP_PACKAGE="${{ env.PACKAGE_NAME }}"
          
          cat << EOF > emulator_script.sh
          #!/bin/bash
          set -e

          echo "APK is installed by the runner action parameter."
          echo "Waiting for boot completion..."
          adb wait-for-device shell 'while [[ -z \$(getprop sys.boot_completed) ]]; do sleep 1; done;'
          
          echo "Launching App (Package: ${APP_PACKAGE}) with Activity: ${APP_ACTIVITY}"
          adb shell am start -n "${APP_PACKAGE}/${APP_ACTIVITY}"
          sleep 5 
          
          # *** NEW RECOVERY STEP: Tap 'Wait' on System UI isn't responding ***
          # Tap at ~50% X, ~58% Y, which should hit the 'Wait' button
          echo "Tapping to dismiss potential ANR/System UI error popup (tapping 'Wait')."
          adb shell input tap 500 580 # Using direct coordinates as a safe fallback
          sleep 2
          
          echo "Detecting emulator resolution..."
          SIZE=\$(adb shell wm size | awk '{print \$NF}' | tr -d '\r')
          WIDTH=\$(echo "\$SIZE" | cut -d'x' -f1)
          HEIGHT=\$(echo "\$SIZE" | cut -d'x' -f2)
          
          if [ -z "\$WIDTH" ] || [ -z "\$HEIGHT" ]; then
            echo "Error: Could not determine screen resolution."
            exit 1
          fi

          echo "Emulator resolution: \${WIDTH}x\${HEIGHT}"
          
          X_DISMISS=\$((WIDTH * 20 / 100))
          Y_DISMISS=\$((HEIGHT * 78 / 100))
          X_CONT=\$((WIDTH * 50 / 100))
          Y_CONT=\$((HEIGHT * 88 / 100))
          
          echo "Tapping DISMISS at \${X_DISMISS},\${Y_DISMISS}"
          adb shell input tap "\$X_DISMISS" "\$Y_DISMISS"
          
          sleep 1
          echo "Tapping CONTINUE 4 times"
          
          for i in \$(seq 1 4); do
            adb shell input tap "\$X_CONT" "\$Y_CONT"
            sleep 1
          done
          
          # --- SCREENSHOT CAPTURE ---
          echo "Taking screenshot and pulling artifact..."
          adb shell screencap /sdcard/screenshot.png
          adb pull /sdcard/screenshot.png ./screenshot.png 
          
          echo "Printing filtered app logs..."
          adb logcat -s "${APP_PACKAGE}" -t 50
          echo "Script execution complete."
          EOF
          chmod +x emulator_script.sh

      - name: Run emulator, Install App, and Control
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis 
          arch: x86
          force-avd-creation: true
          emulator-options: "-no-window -noaudio -no-boot-anim"
          apk-path: base-patched.apk 
          script: ./emulator_script.sh
          
      - name: Upload Debug Screenshot
        uses: actions/upload-artifact@v4
        if: always() 
        with:
          name: emulator-screenshot
          path: screenshot.png
